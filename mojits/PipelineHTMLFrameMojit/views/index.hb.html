<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript">var MOJITO_INIT=new Date().getTime();</script>
{{#meta}}
<meta name="{{name}}" content="{{content}}">
{{/meta}}
{{^meta}}
<meta name="creator" content="Yahoo! Mojito {{mojito_version}}">
{{/meta}}

<title>{{title}}</title>

{{{top}}}

</head>
<body>

{{{child}}}

{{{bottom}}}

<script type="text/javascript">
var Pipeline = function Pipeline(config) {
		this.events = new Y.Pipeline.Events();
		this.sections = {};
	},
	Section = function Section(config, pipeline) {
		this.pipeline = pipeline;
		Y.mix(this, config, true);
	};

Pipeline.prototype.push = function (sectionConfig) {
	var pipeline = this,
		section = this.getSection(sectionConfig),
		displaySubscription;

	section.flushed = true;
	Y.mix(section, sectionConfig, true);

	// subscribe to any events specified by the task
	Y.Array.each(Task.EVENT_TYPES, function (targetAction) {
		if (!task[targetAction]) {
			return;
		}
		var targets = {};
		targets[task.id] = [targetAction];
		this.events.subscribe(targets, task[targetAction]);
	}, this);

	// TODO: combine the default displayTest with the user's displayTest

	// subscribe to events for the display action
	if (section.displayTest()) {
		pipeline.display(section);
	} else {
		displaySubscription = this.events.subscribe(section.displayTargets, function (event, done) {
			if (section.displayTest(section)) {
				displaySubscription.unsubscribe();
				pipeline.display(section, done);
			} else {
				done();
			}
		});
	}
};

Pipeline.prototype.getSection = function (config) {
	var section;
	if (typeof config === 'string' || typeof config === 'number') {
		config = {
			id: config
		};
		section = this.sections[config] = new Section(config, this);
		return section;
	}
	section = this.sections[config.id];
	if (section) {
		Y.mix(section, config, true);
	} else {
		section = this.sections[config.id] = new Section(config, this);
	}
	return section;
};

Pipeline.prototype.display = function (section) {
	var stub = document.getElementById(section.id),
		pipeline = this,
		sectionDOM;
	if (stub) {
		this.events.fire(section.id, 'beforeDisplay', function () {
			sectionDOM = document.createElement();
			sectionDOM.outerHTML = section.markup;
			stub.parentNode.insertBefore(sectionDOM, stub);
			pipeline.events.fire(section.id, 'afterDisplay');
		});
	}
};

Section._combineTests = function () {
	return function () {
		return !Y.Array.some(arguments, function (nextFn) {
			return !nextFn.call();
		});
	};
};
Section.EVENT_TYPES = ['beforeDisplay', 'afterDisplay'];

Section.prototype.displayTest = function () {
	return true;
};

Y.namespace('Pipeline') = Pipeline;
</script>

{{{end}}}
